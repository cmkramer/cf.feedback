"use strict";angular.module("cf.feedback",[]),angular.module("cf.feedback").constant("FEEDBACK_TYPE",{SUCCESS:"SUCCESS",ERROR:"ERROR",ALERT:"ALERT",NOTICE:"NOTICE"}),angular.module("cf.feedback").directive("feedback",function(){return{scope:{fbOptions:"=",elementId:"@feedback"},restrict:"A",transclude:!0,compile:function(e,t,n){return function(t){n(t,function(t){e.append(t)})}},controller:["$scope","$timeout","cfFeedback","FEEDBACK_TYPE",function(e,t,n,a){var i=0,c=null,r=[],s=0,o=n.getDefaultOptions();e.fbOptions&&(o=angular.extend({},o,e.fbOptions));var u=function(e){f(e)};n.subscribe(u,e.elementId),e.$on("$destroy",function(){n.unsubscribe(u,e.elementId)}),1!==o.maxMessages&&(e.feedback=[]),e.hide=function(n,a){1===o.maxMessages?(e.feedback=null,t(function(){s--,"function"==typeof a&&a()},o.replaceTime)):angular.forEach(e.feedback,function(i){if(i.index===n){s++,null!==i.timeout&&clearTimeout(i.timeout);for(var c=0;c<e.feedback.length;c++)if(e.feedback[c].index===n){e.feedback.splice(c,1);break}t(function(){s--,"function"==typeof a&&a()},o.replaceTime)}})};var f=function(e){var t={staticType:e.type,data:e.data},n=l(e.message);n?(t.paths=g(e.type,n),y(t),t.reference=t.paths.reference,t.message=t.reference+" (untranslated)"):(t.message=e.message,t.reference=t.message),t.details=null,t.type=e.type.toLowerCase(),d(t)&&p(t)},l=function(e){return"{"===e[0]&&"}"===e[e.length-1]?e.substring(1,e.length-1):!1},d=function(t){if(o.allowDuplicateStacked)return!0;var n=!0,a=function(e){e.type===t.type&&e.reference===t.reference&&(n=!1)};return 1===o.maxMessages&&e.feedback?a(e.feedback):angular.forEach(e.feedback,function(e){a(e)}),n},p=function(n){1===o.maxMessages&&e.feedback||1!==o.maxMessages&&e.feedback.length+s>=o.maxMessages?(k(a.NOTICE),1!==o.maxMessages||n.reference!==e.feedback.reference||r.length?b(n):E(n)):t(function(){m(n)})},g=function(e,t){var a=n.listTranslations();if(!a.FEEDBACK)throw new Error("Cannot find a FEEDBACK root constant reference in your loaded translations file. Make sure there is a root item called FEEDBACK in your translation file which contains all structured supported feedback messages.");var i,c,r,s=t.split("."),o="";if(i=a.FEEDBACK[e],!i)throw new Error("Cannot find FEEDBACK."+e+" in your translation file. Make sure you group your feedback by type in the translation file.");for(var u=0;u<s.length;u++){if(o+=u>0?"."+s[u]:s[u],!i[s[u]]){i=!1,c?(console.debug("untranslated "+e.toLowerCase()+" feedback reference provided: "+t+". Falling back to most specific message: "+c),r={reference:c,message:c}):(r={reference:"UNKNOWN",message:"UNKNOWN"},console.debug("untranslated "+e.toLowerCase()+" feedback reference provided: "+t));break}i=i[s[u]],i._MESSAGE&&(c=o)}return i&&(r="object"==typeof i?{reference:t,message:c}:t),r},m=function(t,n){t.index=i++,i>2*o.maxMessages&&(i=0),1!==o.maxMessages?e.feedback.push(t):e.feedback=t,h(t,n||o.cleanTimeout)},b=function(t){var n=1===o.maxMessages?e.feedback:e.feedback[0];(null===c||c===a.NOTICE&&t.staticType!==a.NOTICE)&&(t.staticType!==a.NOTICE?h(n,o.minTimeout):h(n,o.queueTimeout),c=t.staticType),k(t)||r.push(t)},E=function(n){t(function(){e.hide(n[0].index,function(){m(n)})})},h=function(t,n){n&&(t.timeout=setTimeout(function(){e.hide(t.index,function(){T()||(c=null)}),e.$digest()},n))},T=function(){if(r.length){var e;e=r.length>1?r[1].staticType!==a.NOTICE?o.minTimeout:o.queueTimeout:o.cleanTimeout,m(r[0],e),r.splice(0,1)}return r.length},k=function(e){for(var t=0;t<r.length;t++)if(r[t].staticType===e.staticType&&(!e||r[t].reference===e.reference))return r.splice(t--,1),!1},y=function(e){"object"==typeof e.paths?(n.translate("FEEDBACK."+e.staticType+"."+e.paths.message+"._MESSAGE",e.data).then(function(t){e.message=t}),n.translate("FEEDBACK."+e.staticType+"."+e.paths.reference+"._DETAILS",e.data).then(function(t){e.details=t})):n.translate("FEEDBACK."+e.staticType+"."+e.paths,e.data).then(function(t){e.message=t})}}]}}),angular.module("cf.feedback").provider("cfFeedback",function(){var e,t,n=!1,a={global:[],identified:{}},i={replaceTime:300,cleanTimeout:6e3,queueTimeout:3e3,minTimeout:1e3,allowDuplicateStacked:!1,maxMessages:1};return{configureTranslations:function(a,i){e=a,t=i,n=!0},configureDefaultOptions:function(e){i=angular.extend({},i,e)},$get:function(){var c=this;return{subscribe:function(e,t){""===t&&(t=void 0),void 0===t?a.global.push(e):(a.identified[t]=a.identified[t]||[],a.identified[t].push(e))},unsubscribe:function(e,t){""===t&&(t=void 0);for(var n=void 0===t?a.global:a.identified[t],i=0;i<n.length;i++)if(n[i]===e){n.splice(i,1);break}},publish:function(e){for(var t=void 0===e.contextElement?a.global:a.identified[e.contextElement],n=0;n<t.length;n++)"function"==typeof t[n]&&t[n](e)},getDefaultOptions:function(){return i},setDefaultOptions:function(e){return c.configureDefaultOptions(e)},listTranslations:function(){return e.apply(this,arguments)},translate:function(){return n?t.apply(this,arguments):arguments[0]}}}}}),angular.module("cf.feedback").service("$feedback",["cfFeedback","FEEDBACK_TYPE",function(e,t){this.error=function(e,a,i){n(t.ERROR,e,a,i)},this.notice=function(e,a,i){n(t.NOTICE,e,a,i)},this.success=function(e,a,i){n(t.SUCCESS,e,a,i)},this.alert=function(e,a,i){n(t.ALERT,e,a,i)};var n=function(t,n,a,i){var c={message:n,type:t};void 0!==a&&(c.data=a),void 0!==i&&(c.contextElement=i),e.publish(c)}}]);