"use strict";angular.module("cf.feedback",[]),angular.module("cf.feedback").constant("FEEDBACK_TYPE",{SUCCESS:"SUCCESS",ERROR:"ERROR",ALERT:"ALERT",NOTICE:"NOTICE"}),angular.module("cf.feedback").directive("feedback",function(){return{scope:{fbOptions:"=",elementId:"@feedback"},restrict:"A",transclude:!0,compile:function(e,n,t){return function(n){t(n,function(n){e.append(n)})}},controller:["$scope","$timeout","cfFeedback","FEEDBACK_TYPE",function(e,n,t,a){var i=0,c=this,s=null,o=[],r=0,f=t.getDefaultOptions();e.fbOptions&&(f=angular.extend({},f,e.fbOptions)),this.handle=function(e){u(e)},this.close=function(){1===f.maxMessages?e.hide():angular.forEach(e.feedback,function(n){e.hide(n.index)})},t.subscribe(c,e.elementId),e.$on("$destroy",function(){t.unsubscribe(c,e.elementId)}),1!==f.maxMessages&&(e.feedback=[]),e.hide=function(t,a){1===f.maxMessages?(e.feedback=null,n(function(){r--,"function"==typeof a&&a()},f.replaceTime)):angular.forEach(e.feedback,function(i){if(i.index===t){r++,null!==i.timeout&&clearTimeout(i.timeout);for(var c=0;c<e.feedback.length;c++)if(e.feedback[c].index===t){e.feedback.splice(c,1);break}n(function(){r--,"function"==typeof a&&a()},f.replaceTime)}})};var u=function(e){var n={staticType:e.type,data:e.data},t=l(e.message);t?(n.paths=g(e.type,t),v(n),n.reference=n.paths.reference,n.message=n.reference+" (untranslated)"):(n.message=e.message,n.reference=n.message),n.details=null,n.type=e.type.toLowerCase(),d(n)&&p(n)},l=function(e){return"{"===e[0]&&"}"===e[e.length-1]?e.substring(1,e.length-1):!1},d=function(n){if(f.allowDuplicateStacked)return!0;var t=!0,a=function(e){e.type!==n.type||e.reference!==n.reference||f.silentReplace||(t=!1)};return 1===f.maxMessages&&e.feedback?a(e.feedback):angular.forEach(e.feedback,function(e){a(e)}),t},p=function(t){1===f.maxMessages&&e.feedback||1!==f.maxMessages&&e.feedback.length+r>=f.maxMessages?(T(a.NOTICE),1!==f.maxMessages||t.reference!==e.feedback.reference||o.length?b(t):h(t)):n(function(){m(t)})},g=function(e,n){var a=t.listTranslations();if(!a.FEEDBACK)throw new Error("Cannot find a FEEDBACK root constant reference in your loaded translations file. Make sure there is a root item called FEEDBACK in your translation file which contains all structured supported feedback messages.");var i,c,s,o=n.split("."),r="";if(i=a.FEEDBACK[e],!i)throw new Error("Cannot find FEEDBACK."+e+" in your translation file. Make sure you group your feedback by type in the translation file.");for(var f=0;f<o.length;f++){if(r+=f>0?"."+o[f]:o[f],!i[o[f]]){i=!1,c?(console.debug("untranslated "+e.toLowerCase()+" feedback reference provided: "+n+". Falling back to most specific message: "+c),s={reference:c,message:c}):(s={reference:"UNKNOWN",message:"UNKNOWN"},console.debug("untranslated "+e.toLowerCase()+" feedback reference provided: "+n));break}i=i[o[f]],i._MESSAGE&&(c=r)}return i&&(s="object"==typeof i?{reference:n,message:c}:n),s},m=function(n,t){n.index=i++,i>2*f.maxMessages&&(i=0),1!==f.maxMessages?e.feedback.push(n):e.feedback=n,E(n,t||f.cleanTimeout)},b=function(n){var t=1===f.maxMessages?e.feedback:e.feedback[0];(null===s||s===a.NOTICE&&n.staticType!==a.NOTICE)&&(n.staticType!==a.NOTICE?E(t,f.minTimeout):E(t,f.queueTimeout),s=n.staticType),T(n)||o.push(n)},h=function(t){n(function(){f.silentReplace&&t.reference===e.feedback.reference&&1===f.maxMessages?(clearTimeout(e.feedback.timeout),m(t)):e.hide((1===f.maxMessages?e.feedback:e.feedback[0]).index,function(){m(t)})})},E=function(n,t){t&&(n.timeout=setTimeout(function(){e.hide(n.index,function(){k()||(s=null)}),e.$digest()},t))},k=function(){if(o.length){var e;e=o.length>1?o[1].staticType!==a.NOTICE?f.minTimeout:f.queueTimeout:f.cleanTimeout,m(o[0],e),o.splice(0,1)}return o.length},T=function(e){for(var n=0;n<o.length;n++)if(o[n].staticType===e.staticType&&(!e||o[n].reference===e.reference))return o.splice(n--,1),!1},v=function(e){"object"==typeof e.paths?(t.translate("FEEDBACK."+e.staticType+"."+e.paths.message+"._MESSAGE",e.data).then(function(n){e.message=n}),t.translate("FEEDBACK."+e.staticType+"."+e.paths.reference+"._DETAILS",e.data).then(function(n){e.details=n})):t.translate("FEEDBACK."+e.staticType+"."+e.paths,e.data).then(function(n){e.message=n})}}]}}),angular.module("cf.feedback").provider("cfFeedback",function(){var e,n,t=!1,a={global:[],identified:{}},i={replaceTime:300,cleanTimeout:6e3,queueTimeout:3e3,minTimeout:1e3,silentReplace:!1,allowDuplicateStacked:!1,maxMessages:1};return{configureTranslations:function(a,i){e=a,n=i,t=!0},configureDefaultOptions:function(e){i=angular.extend({},i,e)},$get:function(){var c=this;return{subscribe:function(e,n){""===n&&(n=void 0),void 0===n?a.global.push(e):(a.identified[n]=a.identified[n]||[],a.identified[n].push(e))},unsubscribe:function(e,n){""===n&&(n=void 0);var t=void 0===n?a.global:a.identified[n];if(t)for(var i=0;i<t.length;i++)if(t[i].handle===e.handle){t.splice(i,1);break}},publish:function(e){var n=void 0===e.contextElement?a.global:a.identified[e.contextElement];if(n)for(var t=0;t<n.length;t++)n[t]&&"function"==typeof n[t].handle&&n[t].handle(e)},close:function(e){var n=void 0===e?a.global:a.identified[e];if(n)for(var t=0;t<n.length;t++)n[t]&&"function"==typeof n[t].close&&n[t].close()},getDefaultOptions:function(){return i},setDefaultOptions:function(e){return c.configureDefaultOptions(e)},listTranslations:function(){return e.apply(this,arguments)},translate:function(){return t?n.apply(this,arguments):arguments[0]}}}}}),angular.module("cf.feedback").service("$feedback",["cfFeedback","FEEDBACK_TYPE","$timeout",function(e,n,t){this.error=function(e,t,i){a(n.ERROR,e,t,i)},this.notice=function(e,t,i){a(n.NOTICE,e,t,i)},this.success=function(e,t,i){a(n.SUCCESS,e,t,i)},this.alert=function(e,t,i){a(n.ALERT,e,t,i)},this.close=function(n){e.close(n)};var a=function(n,t,a,i){var c={message:t,type:n};void 0!==a&&(c.data=a),void 0!==i&&(c.contextElement=i),e.publish(c)}}]);